// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright (c) 2019 Fuzhou Rockchip Electronics Co., Ltd
 */

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/interrupt-controller/irq.h>
#include <dt-bindings/pinctrl/rockchip.h>
#include <dt-bindings/pwm/pwm.h>

#include "rk3399pro.dtsi"
#include "rk3399-opp.dtsi"

/ {
	compatible = "toybrick,rk3399prox-som", "rockchip,rk3399pro";

	/*
	 * Really, this is supplied by vcc5v0_sys, and vcc_buck5 only
	 * drives the enable pin, but we can't quite model that.
	 */
	vdd_log: vdd-log {
		compatible = "regulator-fixed";
		regulator-name = "vdd_log";
		regulator-always-on;
		regulator-boot-on;
		regulator-min-microvolt = <900000>;
		regulator-max-microvolt = <900000>;
		vin-supply = <&vcc_buck5>;
	};

	rk809_sound: rk809-sound {
		compatible = "simple-audio-card";

		simple-audio-card,format = "i2s";
		simple-audio-card,name = "Analog RK809";
		simple-audio-card,mclk-fs = <256>;

		simple-audio-card,cpu {
			sound-dai = <&i2s1>;
		};

		simple-audio-card,codec {
			sound-dai = <&rk809>;
		};
	};
};

&i2c0 {
	status = "okay";

	clock-frequency = <400000>;
	i2c-scl-falling-time-ns = <30>;
	i2c-scl-rising-time-ns = <180>;

	vdd_cpu_b: regulator@1c {
		compatible = "tcs,tcs4525";
		reg = <0x1c>;

		/* Also has an enable pin driven by vcc_1v8. */
		fcs,suspend-voltage-selector = <1>;
		pinctrl-0 = <&cpu_b_sleep_h>;
		vsel-gpios = <&gpio1 RK_PC1 GPIO_ACTIVE_HIGH>;
		vin-supply = <&vcc5v0_sys>;

		regulator-name = "vdd_cpu_b";
		regulator-min-microvolt = <712500>;
		regulator-max-microvolt = <1500000>;
		regulator-ramp-delay = <2300>;
		regulator-always-on;
		regulator-boot-on;

		regulator-state-mem {
			regulator-off-in-suspend;
		};
	};

	vdd_gpu: regulator@10 {
		compatible = "tcs,tcs4525";
		reg = <0x10>;

		/* Also has an enable pin driven by vcc_1v8. */
		fcs,suspend-voltage-selector = <1>;
		pinctrl-0 = <&gpu_sleep_h>;
		vsel-gpios = <&gpio1 RK_PB6 GPIO_ACTIVE_HIGH>;
		vin-supply = <&vcc5v0_sys>;

		regulator-name = "vdd_gpu";
		regulator-min-microvolt = <735000>;
		regulator-max-microvolt = <1500000>;
		regulator-ramp-delay = <2300>;
		regulator-always-on;
		regulator-boot-on;

		regulator-state-mem {
			regulator-off-in-suspend;
		};
	};

	rk809: pmic@20 {
		compatible = "rockchip,rk809";
		reg = <0x20>;

		#clock-cells = <1>;
		#sound-dai-cells = <0>;

		interrupt-parent = <&gpio1>;
		interrupts = <RK_PC2 IRQ_TYPE_LEVEL_LOW>;
		pinctrl-names = "default";
		pinctrl-0 = <&pmic_int_l>, <&i2s_clk>;

		clock-names = "mclk";
		clocks = <&cru SCLK_I2S_8CH_OUT>;
		clock-output-names = "rk809-clkout1", "rk809-clkout2";

		rockchip,system-power-controller;
		wakeup-source;

		vcc1-supply = <&vcc5v0_sys>;
		vcc2-supply = <&vcc5v0_sys>;
		vcc3-supply = <&vcc5v0_sys>;
		vcc4-supply = <&vcc5v0_sys>;
		vcc5-supply = <&vcc_buck5>;
		vcc6-supply = <&vcc_buck5>;
		vcc7-supply = <&vcc5v0_sys>;
		vcc8-supply = <&vcc3v3_sys>;
		vcc9-supply = <&vcc5v0_sys>;

		regulators {
			vdd_center: DCDC_REG1 {
				regulator-name = "vdd_center";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <750000>;
				regulator-max-microvolt = <1350000>;
				regulator-initial-mode = <0x2>;
				regulator-state-mem {
					/* Schematic says this is off in suspend? */
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <900000>;
				};
			};

			vdd_cpu_l: DCDC_REG2 {
				regulator-name = "vdd_cpu_l";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <750000>;
				regulator-max-microvolt = <1350000>;
				regulator-ramp-delay = <6001>;
				regulator-initial-mode = <0x2>;
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vcc_ddr: DCDC_REG3 {
				regulator-name = "vcc_ddr";
				regulator-always-on;
				regulator-boot-on;
				regulator-initial-mode = <0x2>;
				regulator-state-mem {
					regulator-on-in-suspend;
				};
			};

			vcc3v3_sys: DCDC_REG4 {
				regulator-name = "vcc3v3_sys";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;
				regulator-initial-mode = <0x2>;
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <3300000>;
				};
			};

			vcc_buck5: DCDC_REG5 {
				regulator-name = "vcc_buck5";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <2200000>;
				regulator-max-microvolt = <2200000>;
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <2200000>;
				};
			};

			vcc_0v9_s3: LDO_REG1 {
				regulator-name = "vcc_0v9_s3";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <900000>;
				regulator-max-microvolt = <900000>;
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <900000>;
				};
			};

			vcc_1v8_s3: LDO_REG2 {
				regulator-name = "vcc_1v8_s3";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <1800000>;
				regulator-state-mem {
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <1800000>;
				};
			};

			vcca_0v9: LDO_REG3 {
				regulator-name = "vcca_0v9";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <900000>;
				regulator-max-microvolt = <900000>;
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vcc_1v8: LDO_REG4 {
				regulator-name = "vcc_1v8";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <1800000>;
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vcc1v8_dvp: LDO_REG5 {
				regulator-name = "vcc1v8_dvp";
				regulator-always-on;
				/* Scheamtic says this off at boot? */
				regulator-boot-on;
				regulator-min-microvolt = <1800000>;
				regulator-max-microvolt = <1800000>;
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vcc_1v5: LDO_REG6 {
				regulator-name = "vcc_1v5";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <1500000>;
				regulator-max-microvolt = <1500000>;
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vccio_3v0: LDO_REG7 {
				regulator-name = "vccio_3v0";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <3000000>;
				regulator-max-microvolt = <3000000>;
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};

			vccio_sd: LDO_REG8 {
				regulator-name = "vccio_sd";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <3000000>;
				regulator-max-microvolt = <3000000>;
				regulator-state-mem {
					/* Schematic says this is off in suspend? */
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <3000000>;
				};
			};

			vcc3v0_sd: LDO_REG9 {
				regulator-name = "vcc3v0_sd";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <3000000>;
				regulator-max-microvolt = <3000000>;
				regulator-state-mem {
					/* Schematic says this is off in suspend? */
					regulator-on-in-suspend;
					regulator-suspend-microvolt = <3000000>;
				};
			};

			/* Not used on the SOM, and not exposed via the SOM's connector. */
			/*
			vcc5v0_usb: SWITCH_REG1 {
				regulator-name = "vcc5v0_usb";
				regulator-min-microvolt = <5000000>;
				regulator-max-microvolt = <5000000>;
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};
			*/

			vccio_3v3: SWITCH_REG2 {
				regulator-name = "vccio_3v3";
				regulator-always-on;
				regulator-boot-on;
				regulator-min-microvolt = <3300000>;
				regulator-max-microvolt = <3300000>;
				regulator-state-mem {
					regulator-off-in-suspend;
				};
			};
		};
	};
};

&cpu_l0 {
	cpu-supply = <&vdd_cpu_l>;
};

&cpu_l1 {
	cpu-supply = <&vdd_cpu_l>;
};

&cpu_l2 {
	cpu-supply = <&vdd_cpu_l>;
};

&cpu_l3 {
	cpu-supply = <&vdd_cpu_l>;
};

&cpu_b0 {
	cpu-supply = <&vdd_cpu_b>;
};

&cpu_b1 {
	cpu-supply = <&vdd_cpu_b>;
};

&gpu {
	status = "okay";

	mali-supply = <&vdd_gpu>;
};

&pmu_io_domains {
	status = "okay";

	/*
	 * PMUIO1_VDD_1V8 = VCC_1V8_S3
	 * PMU_VDD_1V8 = VCC_1V8_S3
	 * PMU_VDD_0V9 = VCC_0V9_S3
	 * PMUIO2_VDDPST = VCC_1V8_S3
	 */

	pmu1830-supply = <&vcc_1v8_s3>; /* PMUIO2_VDD */
};

&io_domains {
	status = "okay";

	/*
	 * APIO1_VDD = VCCIO_3V3_S0
	 * APIO1_VDDPST = VCC_1V8_S0
	 * APIO3_VDD_1V8 = VCC_1V8_S3
	 * APIO4_VDDPST = VCC_1V5_S0
	 * APIO5_VDDPST = VCC_1V8_S0
	 */
	audio-supply = <&vcc_1v8>; /* APIO5_VDD */
	bt656-supply = <&vcc1v8_dvp>; /* APIO2_VDD */
	gpio1830-supply = <&vccio_3v0>; /* APIO4_VDD */
	sdmmc-supply = <&vccio_sd>; /* SDMMC0_VDD */
};

i2c1_1v8: &i2c1 {};

i2c3_hdmi: &i2c3 {};

i2c4_tp: &i2c4 {};

&hdmi {
	avdd-0v9-supply = <&vcca_0v9>;
	avdd-1v8-supply = <&vcc_1v8>;
};

&pcie0 {
	vpcie3v3-supply = <&vcc_0v9_s3>;
	vpcie1v8-supply = <&vcc_1v8_s3>;
};

&saradc {
	vref-supply = <&vcc_1v8>;
};

&tsadc {
	status = "okay";

	/* tshut mode 0:CRU 1:GPIO */
	rockchip,hw-tshut-mode = <1>;
	/* tshut polarity 0:LOW 1:HIGH */
	rockchip,hw-tshut-polarity = <1>;
};

&i2s1 {
	status = "okay";

	#sound-dai-cells = <0>;
};

&pinctrl {
	/*
	 * pinctrl settings for pins that have no real owners.
	 *
	 * At the moment settings are identical for S0 and S3, but if we later
	 * need to configure things differently for S3 we'll adjust here.
	 */
	pinctrl-names = "default";
	pinctrl-0 = <
		&ap_pwroff	/* AP will auto-assert this when in S3 */
		&clk_32k	/* This pin is always 32k on gru boards */
	>;

	wifi {
		/* Says _l but is actually active-high. */
		wifi_host_wake_l: wifi-host-wake-l {
			rockchip,pins = <0 RK_PA3 RK_FUNC_GPIO &pcfg_pull_none>;
		};

		/* Says _h but is actually active-low. */
		wifi_reg_on_h: wifi-reg-on-h {
			rockchip,pins = <2 RK_PD3 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};

	bt {
		/* Says _l but is actually active-high. */
		bt_host_wake_l: bt-host-wake-l {
			rockchip,pins = <0 RK_PA5 RK_FUNC_GPIO &pcfg_pull_none>;
		};

		/* Says _l but is actually active-high. */
		bt_wake_l: bt-wake-l {
			rockchip,pins = <2 RK_PD2 RK_FUNC_GPIO &pcfg_pull_none>;
		};

		/* Says _h but is actually active-low. */
		bt_reg_on_h: bt-reg-on-h {
			rockchip,pins = <2 RK_PD4 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};

	headphone {
		phone_det_h: phone-det-h {
			rockchip,pins = <0 RK_PB5 RK_FUNC_GPIO &pcfg_pull_up>;
		};
	};

	rtc {
		hym_rtc_int_l: hym-rtc-int-l {
			rockchip,pins = <1 RK_PB2 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};

	usb {
		usb5v0_en_h: usb5v0-en-h {
			rockchip,pins = <1 RK_PB5 RK_FUNC_GPIO &pcfg_pull_down>;
		};

		vcc5v0_typec0_en: vcc5v0-typec0-en {
			rockchip,pins = <4 RK_PC5 RK_FUNC_GPIO &pcfg_pull_down>;
		};

		typec_cc_int_l: typec-cc-int-l {
			rockchip,pins = <1 RK_PA2 RK_FUNC_GPIO &pcfg_pull_up>;
		};
	};

	gpu {
		gpu_sleep_h: gpu-sleep-h {
			rockchip,pins = <1 RK_PB6 RK_FUNC_GPIO &pcfg_pull_down>;
		};
	};

	cpu {
		cpu_b_sleep_h: cpu-b-sleep-h {
			rockchip,pins = <1 RK_PC1 RK_FUNC_GPIO &pcfg_pull_down>;
		};
	};

	pmic {
		pmic_int_l: pmic-int-l {
			rockchip,pins = <1 RK_PC2 RK_FUNC_GPIO &pcfg_pull_up>;
		};
	};

	pcie {
		/* Says _l, but is actually active-high. */
		pcie_perst_l: pcie-perst-l {
			rockchip,pins = <1 RK_PB1 RK_FUNC_GPIO &pcfg_pull_none>;
		};
	};

	leds {
		led_rgb_r: led-rgb-r {
			rockchip,pins = <2 RK_PA3 RK_FUNC_GPIO &pcfg_pull_up>;
		};

		led_rgb_g: led-rgb-g {
			rockchip,pins = <2 RK_PA4 RK_FUNC_GPIO &pcfg_pull_up>;
		};
	};

	i2s {
		i2s_clk: i2s-clk {
			rockchip,pins = <4 RK_PA0 1 &pcfg_pull_none>;
		};
	};
};
